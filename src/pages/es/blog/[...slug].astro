---
import { getCollection } from "astro:content";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import Navbar from "../../../components/astro/Navbar.astro";
import { getLocalizedCategoryById } from "../../../lib/categories";
import { formatDate } from "../../../lib/utils";
import { getTranslation } from "../../../lib/i18n";
import { getRelativeLocaleUrl } from "astro:i18n";
import FloatingBlogMenu from "../../../components/astro/FloatingBlogMenu.astro";

const currentLocale = Astro.currentLocale || "en";
const t = (key: string) => getTranslation(currentLocale, key);

export async function getStaticPaths() {
    // This is the Spanish route (/es/blog/...)
    // Only get Spanish posts
    const allEntries = await getCollection("blog", ({ data }) => {
        if (data.draft) return false;
        // Filter for Spanish locale only
        return data.locale === "es";
    });
    
    // Generate paths for each entry
    const paths: Array<{ params: { slug: string }; props: { entry: typeof allEntries[0] } }> = [];
    
    for (const entry of allEntries) {
        // Strip locale prefix (en/ or es/) from slug to maintain consistent URLs
        const slug = entry.slug.replace(/^(en|es)\//, '');
        
        paths.push({
            params: { slug },
            props: { entry },
        });
    }
    
    return paths;
}

const { entry } = Astro.props;
const entryLocale = entry.data.locale || "en";

// Ensure entry matches current locale - if not, this route shouldn't exist
// Astro i18n routing should handle this, but we double-check here
if (entryLocale !== currentLocale) {
    // This should not happen if routing is correct, but if it does,
    // we'll still render to prevent 404s (content will be in wrong language though)
    // In a production app, you might want to redirect or show a 404 page
}

const { Content } = await entry.render();
const categoryData = getLocalizedCategoryById(entry.data.category, currentLocale);
---

<BaseLayout
    title={`${entry.data.title} - Jrdz`}
    description={entry.data.description}
>
    <Navbar />

    <article class="max-w-6xl mx-auto px-4 py-8 md:py-12 lg:py-16">
        <!-- Breadcrumb -->
        <nav class="breadcrumb-section mb-6 md:mb-8">
            <div class="text-sm breadcrumbs">
                <ul>
                    <li>
                        <a
                            href={getRelativeLocaleUrl(currentLocale, "/")}
                            class="text-base-content/60 hover:text-base-content transition-colors"
                        >
                            {t("common.home")}
                        </a>
                    </li>
                    <li>
                        <a
                            href={getRelativeLocaleUrl(currentLocale, "/blog")}
                            class="text-base-content/60 hover:text-base-content transition-colors"
                        >
                            {t("common.blog")}
                        </a>
                    </li>
                    {
                        categoryData && (
                            <li>
                                <a
                                    href={`/blog/${categoryData.id}`}
                                    class="text-base-content/60 hover:text-base-content transition-colors"
                                >
                                    {categoryData.name}
                                </a>
                            </li>
                        )
                    }
                    <li class="text-base-content truncate max-w-[200px]">
                        {entry.data.title}
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Header -->
        <header class="mb-8 md:mb-12">
            <!-- Category & Subcategory -->
            <div class="flex flex-wrap items-center gap-3 mb-4">
                {
                    categoryData?.icon && (
                        <span class="text-2xl md:text-3xl">
                            {categoryData.icon}
                        </span>
                    )
                }
                <div class="badge badge-primary badge-lg font-medium">
                    {categoryData?.name || entry.data.category}
                </div>
                {
                    entry.data.subcategory && (
                        <div class="badge badge-outline badge-lg">
                            {entry.data.subcategory}
                        </div>
                    )
                }
            </div>

            <!-- Title -->
            <h1
                class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4 md:mb-6 text-base-content leading-tight"
            >
                {entry.data.title}
            </h1>

            <!-- Meta Info -->
            <div
                class="flex flex-wrap items-center gap-3 md:gap-4 text-sm md:text-base text-base-content/70 mb-4"
            >
                <time
                    datetime={entry.data.pubDate.toISOString()}
                    class="flex items-center gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        ></path>
                    </svg>
                    {formatDate(entry.data.pubDate)}
                </time>
                        {
                            entry.data.updatedDate && (
                                <span class="flex items-center gap-2">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                        />
                                    </svg>
                                    {t("common.updated")} {formatDate(entry.data.updatedDate)}
                                </span>
                            )
                        }
            </div>

            <!-- Tags -->
            {
                entry.data.tags && entry.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                        {entry.data.tags.map((tag) => (
                            <span class="badge badge-ghost badge-sm md:badge-md">
                                {tag}
                            </span>
                        ))}
                    </div>
                )
            }
        </header>

        <!-- Content -->
        <div
            class="prose prose-sm md:prose-base lg:prose-lg max-w-none bg-base-100 rounded-xl shadow-lg p-6 md:p-8 lg:p-10"
            data-video-url={entry.data.video || ''}
            data-video-title={`${entry.data.title} - Video`}
            id="blog-content"
        >
            <Content />
        </div>

        <!-- Navigation Links -->
        <nav class="mt-8 md:mt-12 pt-8 border-t border-base-content/10">
            <div class="flex flex-wrap gap-3 md:gap-4">
                <a
                    href={getRelativeLocaleUrl(currentLocale, "/blog")}
                    class="inline-flex items-center gap-2 px-6 py-3 rounded-lg border-2 border-base-content/20 hover:border-primary hover:bg-primary/5 transition-all duration-200 text-base-content font-medium"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    {t("common.allPosts")}
                </a>
                {
                    categoryData && (
                        <a
                            href={getRelativeLocaleUrl(currentLocale, `/blog/${categoryData.id}`)}
                            class="inline-flex items-center gap-2 px-6 py-3 rounded-lg border-2 border-primary bg-primary text-primary-content hover:bg-primary/90 hover:border-primary/90 transition-all duration-200 font-medium"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                                />
                            </svg>
                            {t("common.moreIn")} {categoryData.name}
                        </a>
                    )
                }
            </div>
        </nav>
    </article>

    <!-- Floating Menu -->
    <FloatingBlogMenu categoryData={categoryData} />
</BaseLayout>

<style>
    /* Article fade-in animation */
    article {
        animation: fadeInUp 0.6s ease-out;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Breadcrumb truncation for mobile */
    .breadcrumbs li:last-child {
        max-width: 200px;
    }

    @media (max-width: 640px) {
        .breadcrumbs li:last-child {
            max-width: 120px;
        }
    }
</style>

<script>
    // Replace {{video}} placeholder with actual video iframe
    document.addEventListener('DOMContentLoaded', () => {
        const contentDiv = document.getElementById('blog-content');
        if (!contentDiv) return;
        
        const videoUrl = contentDiv.getAttribute('data-video-url');
        const videoTitle = contentDiv.getAttribute('data-video-title') || 'Video';
        
        if (videoUrl) {
            // Function to convert regular YouTube URLs to embed format
            // @ts-ignore - Type checking for inline script
            function convertToEmbedUrl(url) {
                // If already an embed URL, just convert to nocookie version
                if (url.includes('/embed/')) {
                    return url.replace('youtube.com', 'youtube-nocookie.com');
                }
                
                // Extract video ID from various YouTube URL formats
                let videoId = null;
                
                // Handle youtube.com/watch?v=VIDEO_ID format
                const watchMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s?#]+)/);
                if (watchMatch) {
                    videoId = watchMatch[1];
                }
                
                // If we found a video ID, convert to embed URL
                if (videoId) {
                    return `https://www.youtube-nocookie.com/embed/${videoId}`;
                }
                
                // If no match, return original URL (might be a different video platform)
                return url;
            }
            
            const enhancedUrl = convertToEmbedUrl(videoUrl);
            
            const videoHtml = `<div class="flex my-6 justify-start">
  <div class="w-full sm:max-w-lg md:max-w-2xl lg:max-w-3xl xl:max-w-4xl">
    <div class="relative pb-[56.25%] h-0 overflow-hidden rounded-lg shadow-md">
      <iframe 
        class="absolute top-0 left-0 w-full h-full border-0"
        src="${enhancedUrl}" 
        title="${videoTitle}" 
        loading="lazy"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
        referrerpolicy="strict-origin-when-cross-origin" 
        allowfullscreen
      ></iframe>
    </div>
  </div>
</div>`;
            
            // Replace all instances of {{video}} in the content
            contentDiv.innerHTML = contentDiv.innerHTML.replace(/\{\{video\}\}/g, videoHtml);
        }
    });
</script>
