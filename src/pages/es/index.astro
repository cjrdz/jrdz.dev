---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Navbar from "../../components/astro/Navbar.astro";
import { sortPostsByDate, formatDateShort } from "../../lib/utils";
import { getLocalizedCategoryById } from "../../lib/categories";
import { getTranslation, getTranslationObject } from "../../lib/i18n";
import { getRelativeLocaleUrl } from "astro:i18n";
import '../../styles/home.css';

const currentLocale = Astro.currentLocale || "en";
const t = (key: string) => getTranslation(currentLocale, key);
const homeT = getTranslationObject(currentLocale, "home") || {};

// Get all published blog posts for current locale
const allPosts = await getCollection("blog", ({ data }) => {
    if (currentLocale === "en") {
        return !data.draft && (data.locale === "en" || !data.locale);
    }
    return !data.draft && data.locale === currentLocale;
});

// Sort posts by date (newest first) - these are the most recent/popular posts
const sortedPosts = sortPostsByDate(allPosts);

// Get top posts for carousel (most recent 4)
const featuredPosts = sortedPosts.slice(0, 4);

// Navigation helper function
const getNavigationSlides = (currentIndex: number, totalSlides: number) => ({
    prev: currentIndex === 0 ? totalSlides : currentIndex,
    next: currentIndex === totalSlides - 1 ? 1 : currentIndex + 2
});
---

<BaseLayout
        title={`${t("common.home")} - Jrdz`}
        description="Your friendly guide to technology, cloud computing, cybersecurity, networking, and development"
>
    <Navbar />

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <header class="text-center mb-2 anim-item">
            <h1 class="text-4xl font-bold mb-4 text-primary">{homeT.title || t("home.title")}</h1>
        </header>

        <!-- Welcome Section -->
        <section class="card bg-base-100 shadow-xl mb-12 anim-item delay-100">
            <div class="card-body">
                <div class="space-y-6 text-lg leading-relaxed">
                    <p set:html={t("home.welcome.paragraph1")} />
                    <p set:html={t("home.welcome.paragraph2")} />
                </div>

                <div class="card-actions justify-center mt-6">
                    <a href={getRelativeLocaleUrl(currentLocale, "/blog")} class="btn btn-primary btn-lg">
                        {t("home.exploreBlog")}
                    </a>
                </div>
            </div>
        </section>

        <!-- Featured Blog Posts Carousel -->
        {
            featuredPosts.length > 0 && (
                <section
                        id="blog-carousel"
                        class="carousel w-full rounded-xl shadow-2xl mb-8 anim-item delay-200"
                        aria-label="Featured blog posts carousel"
                >
                    {featuredPosts.map((post, index) => {
                        const { prev, next } = getNavigationSlides(index, featuredPosts.length);
                        const categoryData = getLocalizedCategoryById(post.data.category, currentLocale);
                        // Strip locale prefix (en/ or es/) from slug to maintain consistent URLs
                        const slug = post.slug.replace(/^(en|es)\//, '');

                        return (
                                <div id={`slide${index + 1}`} class="carousel-item relative w-full">
                                    <a
                                            href={getRelativeLocaleUrl(currentLocale, `/blog/${slug}`)}
                                            class="block w-full h-full group"
                                    >
                                        <div class="card bg-base-100 shadow-xl w-full h-[400px] rounded-xl overflow-hidden">
                                            <div class="card-body p-8 flex flex-col justify-between h-full">
                                                <!-- Category Badge -->
                                                <div class="flex items-center gap-2 mb-4">
                                                    {
                                                        categoryData?.icon && (
                                                            <span class="text-2xl">
                                                                {categoryData.icon}
                                                            </span>
                                                        )
                                                    }
                                                    <span class="badge badge-primary badge-lg">
                                                        {categoryData?.name || post.data.category}
                                                    </span>
                                                    {
                                                        post.data.subcategory && (
                                                            <span class="badge badge-outline badge-sm">
                                                                {post.data.subcategory}
                                                            </span>
                                                        )
                                                    }
                                                </div>

                                                <!-- Title -->
                                                <h2 class="text-3xl md:text-4xl font-bold mb-4 group-hover:text-primary transition-colors line-clamp-2">
                                                    {post.data.title}
                                                </h2>

                                                <!-- Description -->
                                                <p class="text-base text-base-content/70 line-clamp-3 mb-6 grow">
                                                    {post.data.description}
                                                </p>

                                                <!-- Footer -->
                                                <div class="flex justify-between items-center pt-4 border-t border-base-content/10">
                                                    <time
                                                            datetime={post.data.pubDate.toISOString()}
                                                            class="text-sm text-base-content/60"
                                                    >
                                                        {formatDateShort(post.data.pubDate)}
                                                    </time>
                                                    <span class="text-primary font-medium group-hover:underline">
                                                        {t("common.readMore")}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </a>

                                    <!-- Navigation Arrows -->
                                    <div class="absolute left-5 right-5 top-1/2 flex -translate-y-1/2 transform justify-between z-10">
                                        <a
                                                href={`#slide${prev}`}
                                                class="btn btn-circle btn-ghost bg-base-100/80 hover:bg-base-100 border-none"
                                                aria-label={t("common.previous")}
                                        >
                                            ❮
                                        </a>
                                        <a
                                                href={`#slide${next}`}
                                                class="btn btn-circle btn-ghost bg-base-100/80 hover:bg-base-100 border-none"
                                                aria-label={t("common.next")}
                                        >
                                            ❯
                                        </a>
                                    </div>
                                </div>
                        );
                    })}
                </section>
            )
        }
    </div>
</BaseLayout>

<script>
    import "../../lib/client/home.ts";
</script>